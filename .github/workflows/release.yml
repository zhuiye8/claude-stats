name: å‘å¸ƒæ–°ç‰ˆæœ¬

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ v1.0.0 è¿™æ ·çš„æ ‡ç­¾æ—¶è§¦å‘

jobs:
  build:
    name: æ„å»ºå¤šå¹³å°äºŒè¿›åˆ¶æ–‡ä»¶
    runs-on: ubuntu-latest
    strategy:
      matrix:
        goos: [linux, windows, darwin]
        goarch: [amd64, arm64]
        exclude:
          # Windowsä¸æ”¯æŒarm64æ„å»º
          - goos: windows
            goarch: arm64

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Goç¯å¢ƒ
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: è·å–ä¾èµ–
      run: go mod download

    - name: æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
      run: |
        # è®¾ç½®æ„å»ºå‚æ•°
        VERSION=${GITHUB_REF#refs/tags/}
        BUILD_TIME=$(date -u '+%Y-%m-%d_%H:%M:%S')
        GIT_COMMIT=${GITHUB_SHA::8}
        
        # æ„å»º
        if [ "$GOOS" = "windows" ]; then
          BINARY_NAME="claude-stats-${GOOS}-${GOARCH}.exe"
        else
          BINARY_NAME="claude-stats-${GOOS}-${GOARCH}"
        fi
        
        go build -ldflags="-X main.Version=$VERSION -X main.BuildTime=$BUILD_TIME -X main.GitCommit=$GIT_COMMIT" -o $BINARY_NAME .
        
        # åˆ›å»ºå‹ç¼©åŒ…
        if [ "$GOOS" = "windows" ]; then
          zip "${BINARY_NAME%.exe}.zip" $BINARY_NAME README.md LICENSE
        else
          tar -czf "${BINARY_NAME}.tar.gz" $BINARY_NAME README.md LICENSE
        fi

    - name: ä¸Šä¼ æ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: binaries
        path: |
          *.exe
          *.zip
          *.tar.gz

  release:
    name: åˆ›å»ºRelease
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ä¸‹è½½æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v3
      with:
        name: binaries

    - name: åˆ›å»ºRelease
      uses: softprops/action-gh-release@v1
      with:
        files: |
          claude-stats-*
          *.zip
          *.tar.gz
        generate_release_notes: true
        draft: false
        prerelease: false
        body: |
          ## ğŸ‰ Claude Stats ${{ github.ref_name }}

          **å®Œç¾çš„Claude Codeä½¿ç”¨ç»Ÿè®¡å·¥å…·æ–°ç‰ˆæœ¬å‘å¸ƒï¼**

          ### ğŸ“¦ å¿«é€Ÿä¸‹è½½

          **Windowsç”¨æˆ·:**
          ```powershell
          curl -L https://github.com/zhuiye8/claude-stats/releases/download/${{ github.ref_name }}/claude-stats-windows-amd64.exe -o claude-stats.exe
          ```

          **macOSç”¨æˆ· (Intel):**
          ```bash
          curl -L https://github.com/zhuiye8/claude-stats/releases/download/${{ github.ref_name }}/claude-stats-darwin-amd64 -o claude-stats
          chmod +x claude-stats
          ```

          **macOSç”¨æˆ· (Apple Silicon):**
          ```bash
          curl -L https://github.com/zhuiye8/claude-stats/releases/download/${{ github.ref_name }}/claude-stats-darwin-arm64 -o claude-stats
          chmod +x claude-stats
          ```

          **Linuxç”¨æˆ·:**
          ```bash
          curl -L https://github.com/zhuiye8/claude-stats/releases/download/${{ github.ref_name }}/claude-stats-linux-amd64 -o claude-stats
          chmod +x claude-stats
          ```

          ### âœ¨ ä¸»è¦åŠŸèƒ½
          - ğŸ” æ™ºèƒ½è¯†åˆ«APIæ¨¡å¼å’Œè®¢é˜…æ¨¡å¼
          - ğŸ“Š å®Œæ•´çš„tokenç»Ÿè®¡å’Œæˆæœ¬åˆ†æ
          - ğŸ¨ ç¾åŒ–çš„ç»ˆç«¯è¾“å‡ºå’Œå½©è‰²æ”¯æŒ
          - ğŸŒ è·¨å¹³å°æ”¯æŒï¼ˆWindowsã€macOSã€Linuxã€WSLï¼‰
          - ğŸ“ˆ å¯è§†åŒ–è¿›åº¦æ¡å’Œå›¾è¡¨
          - ğŸ’° è®¢é˜…è®¡åˆ’å»ºè®®å’Œæˆæœ¬ä¼˜åŒ–

          ### ğŸš€ ä½¿ç”¨æ–¹æ³•
          ä¸‹è½½åç›´æ¥è¿è¡Œï¼š
          ```bash
          ./claude-stats analyze
          ```

          æ›´å¤šä½¿ç”¨æ–¹æ³•è¯·æŸ¥çœ‹ [README.md](https://github.com/zhuiye8/claude-stats#readme)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 