name: å‘å¸ƒæ–°ç‰ˆæœ¬

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ v1.0.0 è¿™æ ·çš„æ ‡ç­¾æ—¶è§¦å‘
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  # ç®€åŒ–æ„å»ºï¼Œåªæ„å»ºä¸»è¦å¹³å°ï¼Œå‡å°‘èµ„æºæ¶ˆè€—
  build-linux:
    name: æ„å»ºLinuxç‰ˆæœ¬
    runs-on: ubuntu-latest
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Goç¯å¢ƒ
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: æ„å»ºLinuxäºŒè¿›åˆ¶æ–‡ä»¶
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        BUILD_TIME=$(date -u '+%Y-%m-%d_%H:%M:%S')
        GIT_COMMIT=${GITHUB_SHA::8}
        
        # åªæ„å»ºLinux AMD64ï¼Œæœ€å¸¸ç”¨çš„å¹³å°
        GOOS=linux GOARCH=amd64 go build -ldflags="-X main.Version=$VERSION -X main.BuildTime=$BUILD_TIME -X main.GitCommit=$GIT_COMMIT" -o claude-stats-linux-amd64 .
        
        # åˆ›å»ºå‹ç¼©åŒ…
        tar -czf claude-stats-linux-amd64.tar.gz claude-stats-linux-amd64 README.md LICENSE

    - name: ä¸Šä¼ Linuxæ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: linux-binary
        path: claude-stats-linux-amd64.tar.gz

  build-windows:
    name: æ„å»ºWindowsç‰ˆæœ¬
    runs-on: ubuntu-latest
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Goç¯å¢ƒ
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: æ„å»ºWindowsäºŒè¿›åˆ¶æ–‡ä»¶
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        BUILD_TIME=$(date -u '+%Y-%m-%d_%H:%M:%S')
        GIT_COMMIT=${GITHUB_SHA::8}
        
        # æ„å»ºWindows AMD64
        GOOS=windows GOARCH=amd64 go build -ldflags="-X main.Version=$VERSION -X main.BuildTime=$BUILD_TIME -X main.GitCommit=$GIT_COMMIT" -o claude-stats-windows-amd64.exe .
        
        # åˆ›å»ºzipåŒ…
        zip claude-stats-windows-amd64.zip claude-stats-windows-amd64.exe README.md LICENSE

    - name: ä¸Šä¼ Windowsæ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: windows-binary
        path: claude-stats-windows-amd64.zip

  # macOSæ„å»ºå¯èƒ½æ¶ˆè€—æ›´å¤šèµ„æºï¼Œå•ç‹¬å¤„ç†
  build-macos:
    name: æ„å»ºmacOSç‰ˆæœ¬
    runs-on: ubuntu-latest
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è®¾ç½®Goç¯å¢ƒ
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: æ„å»ºmacOSäºŒè¿›åˆ¶æ–‡ä»¶
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        BUILD_TIME=$(date -u '+%Y-%m-%d_%H:%M:%S')
        GIT_COMMIT=${GITHUB_SHA::8}
        
        # æ„å»ºmacOS AMD64 (Intel Mac)
        GOOS=darwin GOARCH=amd64 go build -ldflags="-X main.Version=$VERSION -X main.BuildTime=$BUILD_TIME -X main.GitCommit=$GIT_COMMIT" -o claude-stats-darwin-amd64 .
        tar -czf claude-stats-darwin-amd64.tar.gz claude-stats-darwin-amd64 README.md LICENSE

    - name: ä¸Šä¼ macOSæ„å»ºäº§ç‰©
      uses: actions/upload-artifact@v3
      with:
        name: macos-binary
        path: claude-stats-darwin-amd64.tar.gz

  release:
    name: åˆ›å»ºRelease
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v3

    - name: åˆ›å»ºRelease
      uses: softprops/action-gh-release@v1
      with:
        files: |
          linux-binary/*
          windows-binary/*
          macos-binary/*
        generate_release_notes: true
        draft: false
        prerelease: false
        body: |
          ## ğŸ‰ Claude Stats ${{ github.ref_name }}

          **å®Œç¾çš„Claude Codeä½¿ç”¨ç»Ÿè®¡å·¥å…·æ–°ç‰ˆæœ¬å‘å¸ƒï¼**

          ### ğŸ“¦ å¿«é€Ÿä¸‹è½½

          **Windowsç”¨æˆ·:**
          ```powershell
          curl -L https://github.com/zhuiye8/claude-stats/releases/download/${{ github.ref_name }}/claude-stats-windows-amd64.zip -o claude-stats.zip
          Expand-Archive claude-stats.zip
          ```

          **macOSç”¨æˆ· (Intel):**
          ```bash
          curl -L https://github.com/zhuiye8/claude-stats/releases/download/${{ github.ref_name }}/claude-stats-darwin-amd64.tar.gz -o claude-stats.tar.gz
          tar -xzf claude-stats.tar.gz
          chmod +x claude-stats-darwin-amd64
          ```

          **Linuxç”¨æˆ·:**
          ```bash
          curl -L https://github.com/zhuiye8/claude-stats/releases/download/${{ github.ref_name }}/claude-stats-linux-amd64.tar.gz -o claude-stats.tar.gz
          tar -xzf claude-stats.tar.gz
          chmod +x claude-stats-linux-amd64
          ```

          ### âœ¨ ä¸»è¦åŠŸèƒ½
          - ğŸ” æ™ºèƒ½è¯†åˆ«APIæ¨¡å¼å’Œè®¢é˜…æ¨¡å¼
          - ğŸ“Š å®Œæ•´çš„tokenç»Ÿè®¡å’Œæˆæœ¬åˆ†æ
          - ğŸ¨ ç¾åŒ–çš„ç»ˆç«¯è¾“å‡ºå’Œå½©è‰²æ”¯æŒ
          - ğŸŒ è·¨å¹³å°æ”¯æŒï¼ˆWindowsã€macOSã€Linuxã€WSLï¼‰
          - ğŸ“ˆ å¯è§†åŒ–è¿›åº¦æ¡å’Œå›¾è¡¨
          - ğŸ’° è®¢é˜…è®¡åˆ’å»ºè®®å’Œæˆæœ¬ä¼˜åŒ–

          ### ğŸš€ ä½¿ç”¨æ–¹æ³•
          ä¸‹è½½åç›´æ¥è¿è¡Œï¼š
          ```bash
          ./claude-stats-linux-amd64 analyze
          # æˆ– Windows: claude-stats-windows-amd64.exe analyze
          # æˆ– macOS: ./claude-stats-darwin-amd64 analyze
          ```

          ### ğŸ“– æœ¬åœ°æ„å»º
          å¦‚æœæ‚¨é‡åˆ°ä¸‹è½½é—®é¢˜ï¼Œå¯ä»¥æœ¬åœ°æ„å»ºï¼š
          ```bash
          git clone https://github.com/zhuiye8/claude-stats.git
          cd claude-stats
          go build -o claude-stats .
          ```

          æ›´å¤šä½¿ç”¨æ–¹æ³•è¯·æŸ¥çœ‹ [README.md](https://github.com/zhuiye8/claude-stats#readme)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 